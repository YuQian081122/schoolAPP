<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="åœ‹ç«‹è™å°¾ç§‘æŠ€å¤§å­¸ AI æ ¡åœ’åŠ©æ‰‹ï¼Œæä¾›æ™ºèƒ½å•ç­”ã€æ ¡åœ’è³‡è¨ŠæŸ¥è©¢ã€è¨­æ–½å°èˆªç­‰åŠŸèƒ½">
  <meta name="keywords" content="AIåŠ©æ‰‹,æ ¡åœ’åŠ©æ‰‹,æ™ºèƒ½å•ç­”,åœ‹ç«‹è™å°¾ç§‘æŠ€å¤§å­¸,NFU">
  <!-- Content Security Policyï¼ˆæ”¹é€²ï¼šå®‰å…¨å¢å¼·ï¼‰ -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https: http: localhost:* 127.0.0.1:* *.loca.lt *.ngrok.io *.ngrok-free.app *.zeabur.app *.railway.app;">
  <title>AI æ ¡åœ’åŠ©æ‰‹ - åœ‹ç«‹è™å°¾ç§‘æŠ€å¤§å­¸</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  
  <!-- Leaflet CSS (ä½¿ç”¨ CDNï¼Œæ·»åŠ å‚™ç”¨æ–¹æ¡ˆ) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin="anonymous" 
        onerror="this.onerror=null; this.href='leaflet.css'; console.warn('CDN è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦æœ¬åœ°æ–‡ä»¶');" />
  
  <!-- è‡ªè¨‚ CSS -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="ai-chat.css" />
  
  <!-- å·¥å…·å‡½æ•¸åº« -->
  <script src="utils.js"></script>
  <!-- è¨­å‚™æª¢æ¸¬ -->
  <script src="device-detector.js"></script>
  
  <!-- è³‡æºè¼‰å…¥éŒ¯èª¤è™•ç† -->
  <script>
    // ç›£è½ç¶²çµ¡ç‹€æ…‹
    window.addEventListener('online', function() {
      console.log('âœ… ç¶²çµ¡å·²é€£æ¥');
    });
    window.addEventListener('offline', function() {
      console.warn('âš ï¸ ç¶²çµ¡å·²æ–·é–‹ï¼ŒAI åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨');
    });
    // æ³¨æ„ï¼šéŒ¯èª¤è™•ç†å·²ç§»è‡³ ai-chat.jsï¼Œé¿å…é‡è¤‡è™•ç†
  </script>
  
  <!-- ç§»å‹•è¨­å‚™æª¢æ¸¬ï¼ˆåœ¨ head ä¸­æå‰åŸ·è¡Œï¼Œç¢ºä¿å„ªå…ˆè·³è½‰ï¼‰ -->
  <script>
    // ç«‹å³æª¢æ¸¬ä¸¦è·³è½‰ï¼ˆä¸ç­‰å¾… DOM åŠ è¼‰ï¼‰
    (function() {
      // å¦‚æœå·²ç¶“åœ¨ mobile ç‰ˆæœ¬ï¼Œä¸åŸ·è¡Œä»»ä½•é‚è¼¯
      if (window.location.pathname.includes('mobile')) {
        return;
      }
      
      // ä½¿ç”¨ sessionStorage é˜²æ­¢é‡è¤‡è·³è½‰ï¼ˆé¿å…ä¾†å›è·³å‹•ï¼‰
      const redirectKey = 'ai-chat-redirect-attempted';
      const redirectTimestamp = sessionStorage.getItem(redirectKey);
      const now = Date.now();
      
      // å¦‚æœ 5 ç§’å…§å·²ç¶“å˜—è©¦éè·³è½‰ï¼Œä¸å†é‡è¤‡è·³è½‰
      if (redirectTimestamp && (now - parseInt(redirectTimestamp)) < 5000) {
        console.log('â¸ï¸ [Head] 5 ç§’å…§å·²å˜—è©¦è·³è½‰ï¼Œè·³éæœ¬æ¬¡æª¢æ¸¬');
        return;
      }
      
      // è¨­å‚™æª¢æ¸¬
      const ua = navigator.userAgent || navigator.vendor || window.opera || '';
      const screenWidth = window.innerWidth || screen.width;
      const screenHeight = window.innerHeight || screen.height;
      const platform = navigator.platform || '';
      
      // æª¢æ¸¬ç§»å‹•è¨­å‚™
      const isPhone = /iPhone|iPod|Android.*Mobile|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      const isIPad = /iPad/i.test(ua) || 
                     (platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
                     (ua.includes('Safari') && !ua.includes('Chrome') && navigator.maxTouchPoints > 1);
      const isAndroidTablet = /Android/i.test(ua) && !/Mobile/i.test(ua);
      const isOtherTablet = /Tablet|PlayBook|Silk/i.test(ua);
      const isTouchDevice = 'ontouchstart' in window || 
                           navigator.maxTouchPoints > 0 || 
                           navigator.msMaxTouchPoints > 0;
      
      const isTablet = isIPad || isAndroidTablet || isOtherTablet;
      const isMobileOrTablet = isPhone || isTablet;
      
      // æ›´å¯¬é¬†çš„å±å¹•å¤§å°æª¢æ¸¬
      const isTabletSize = (screenWidth >= 600 && screenWidth <= 2048) && 
                           (screenHeight >= 600 && screenHeight <= 1536);
      const isSmallScreen = screenWidth <= 1366 || screenHeight <= 1024;
      
      // æ±ºå®šæ˜¯å¦é‡å®šå‘ï¼ˆæ¥µå…¶å¯¬é¬†çš„æ¢ä»¶ï¼‰
      // ç­–ç•¥ï¼šåªè¦æª¢æ¸¬åˆ°è§¸æ‘¸è¨­å‚™ï¼Œä¸”å±å¹•å¤§å°åœ¨åˆç†ç¯„åœå…§ï¼Œå°±è·³è½‰
      // 1. æ˜ç¢ºçš„ç§»å‹•è¨­å‚™/å¹³æ¿
      // 2. è§¸æ‘¸è¨­å‚™ + å±å¹•å¤§å°ç¬¦åˆå¹³æ¿ç¯„åœï¼ˆ600-2048px å¯¬ï¼Œ600-1536px é«˜ï¼‰
      // 3. è§¸æ‘¸è¨­å‚™ + å°å±å¹•ï¼ˆä½œç‚ºæœ€å¾Œçš„å‚™ç”¨æª¢æ¸¬ï¼‰
      // 4. è§¸æ‘¸è¨­å‚™ + ä»»ä½•åˆç†çš„å±å¹•å¤§å°ï¼ˆæœ€å¯¬é¬†çš„æ¢ä»¶ï¼‰
      // 5. è§¸æ‘¸è¨­å‚™ + å±å¹•å¯¬åº¦ >= 600pxï¼ˆæœ€æ¿€é€²çš„æ¢ä»¶ï¼Œé©ç”¨æ–¼æ‰€æœ‰å¹³æ¿ï¼‰
      const shouldRedirect = isMobileOrTablet || 
                            (isTouchDevice && isTabletSize) ||
                            (isTouchDevice && isSmallScreen && screenWidth >= 600) ||
                            (isTouchDevice && screenWidth >= 600 && screenWidth <= 2048 && screenHeight >= 400) ||
                            (isTouchDevice && screenWidth >= 600 && screenWidth <= 3000); // æœ€å¯¬é¬†ï¼šè§¸æ‘¸è¨­å‚™ + å¯¬åº¦ 600-3000px
      
      // èª¿è©¦ä¿¡æ¯ï¼ˆå¯åœ¨æ§åˆ¶å°æŸ¥çœ‹ï¼‰
      const debugInfo = {
        ua: ua,
        platform: platform,
        isPhone: isPhone,
        isIPad: isIPad,
        isAndroidTablet: isAndroidTablet,
        isOtherTablet: isOtherTablet,
        isTablet: isTablet,
        isMobileOrTablet: isMobileOrTablet,
        isTouchDevice: isTouchDevice,
        maxTouchPoints: navigator.maxTouchPoints,
        screenWidth: screenWidth,
        screenHeight: screenHeight,
        isTabletSize: isTabletSize,
        isSmallScreen: isSmallScreen,
        shouldRedirect: shouldRedirect
      };
      
      console.log('ğŸ” [Head] è¨­å‚™æª¢æ¸¬:', debugInfo);
      
      if (shouldRedirect) {
        // è¨˜éŒ„è·³è½‰æ™‚é–“æˆ³ï¼Œé˜²æ­¢é‡è¤‡è·³è½‰
        sessionStorage.setItem(redirectKey, now.toString());
        console.log('ğŸ“± [Head] æª¢æ¸¬åˆ°ç§»å‹•è¨­å‚™/å¹³æ¿ï¼Œç«‹å³è·³è½‰åˆ° mobile ç‰ˆæœ¬', debugInfo);
        window.location.replace('ai-chat-mobile.html');
      } else {
        console.log('ğŸ’» [Head] æª¢æ¸¬åˆ°æ¡Œé¢è¨­å‚™ï¼Œä¿æŒç•¶å‰ç‰ˆæœ¬', debugInfo);
      }
    })();
  </script>
</head>
<body>
  <div class="ai-container">
    <!-- é ‚éƒ¨å°èˆª -->
    <header class="ai-header">
      <div class="header-content">
        <h1>ğŸ¤– AI æ ¡åœ’åŠ©æ‰‹</h1>
        <p>åœ‹ç«‹è™å°¾ç§‘æŠ€å¤§å­¸</p>
        <div class="header-actions">
          <button type="button" id="language-toggle-btn" class="header-btn" aria-label="åˆ‡æ›èªè¨€" aria-pressed="false">ğŸŒ ä¸­æ–‡</button>
          <button type="button" id="view-map-btn" class="header-btn" aria-label="æŸ¥çœ‹åœ°åœ–">ğŸ—ºï¸ æŸ¥çœ‹åœ°åœ–</button>
          <button type="button" id="theme-toggle-btn" class="header-btn" aria-label="åˆ‡æ›ä¸»é¡Œ" aria-pressed="false">ğŸŒ“ ä¸»é¡Œ</button>
          <!-- å¹³æ¿æ‰‹å‹•è·³è½‰æŒ‰éˆ•ï¼ˆåƒ…åœ¨è§¸æ‘¸è¨­å‚™ä¸Šé¡¯ç¤ºï¼‰ -->
          <script>
            (function() {
              const isTouchDevice = 'ontouchstart' in window || 
                                   navigator.maxTouchPoints > 0 || 
                                   navigator.msMaxTouchPoints > 0;
              const screenWidth = window.innerWidth || screen.width;
              // å¦‚æœæ˜¯è§¸æ‘¸è¨­å‚™ä¸”å±å¹•å¯¬åº¦ >= 600pxï¼Œé¡¯ç¤ºæ‰‹å‹•è·³è½‰æŒ‰éˆ•
              if (isTouchDevice && screenWidth >= 600 && !window.location.pathname.includes('mobile')) {
                document.addEventListener('DOMContentLoaded', function() {
                  const headerActions = document.querySelector('.header-actions');
                  if (headerActions) {
                    const mobileBtn = document.createElement('button');
                    mobileBtn.type = 'button';
                    mobileBtn.className = 'header-btn';
                    mobileBtn.textContent = 'ğŸ“± æ‰‹æ©Ÿç‰ˆ';
                    mobileBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                    mobileBtn.onclick = function() {
                      window.location.replace('ai-chat-mobile.html');
                    };
                    headerActions.insertBefore(mobileBtn, headerActions.firstChild);
                  }
                });
              }
            })();
          </script>
        </div>
      </div>
    </header>

    <div class="ai-main-layout">
      <!-- å·¦å´ï¼šå°è©±å€ -->
      <div class="chat-panel">
        <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="å°è©±æ¶ˆæ¯">
          <div class="message ai-message">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
              <div class="message-text">
                ä½ å¥½ï¼æˆ‘æ˜¯è™å°¾ç§‘æŠ€å¤§å­¸çš„ AI æ ¡åœ’åŠ©æ‰‹ ğŸ‘‹
              </div>
            </div>
          </div>
        </div>

        <!-- è¨­å‚™å•é¡Œå›å ±è¡¨å–®ï¼ˆç”± AI è§¸ç™¼é¡¯ç¤ºï¼‰ -->
        <div class="issue-form-container" id="issue-form-container" style="display: none;">
          <div class="issue-form-card">
            <div class="issue-form-header">
              <h3>ğŸ›  è¨­å‚™å•é¡Œå›å ±</h3>
              <button type="button" class="issue-form-close" id="issue-form-close-btn" aria-label="é—œé–‰è¡¨å–®">âœ•</button>
            </div>
            <p class="issue-form-description">
              åµæ¸¬åˆ°æ‚¨å›å ±è¨­å‚™é«’æ±¡æˆ–æå£ï¼Œè«‹ç¢ºèªæˆ–ä¿®æ”¹ä»¥ä¸‹è³‡è¨Šå¾Œé€å‡ºï¼š
            </p>
            <form id="issue-form" novalidate>
              <div class="issue-form-row">
                <label for="issue-campus">æ ¡å€</label>
                <select id="issue-campus" required>
                  <option value="">è«‹é¸æ“‡æ ¡å€</option>
                  <option value="campus1">ç¬¬ä¸€æ ¡å€</option>
                  <option value="campus2">ç¬¬äºŒæ ¡å€</option>
                  <option value="campus3">ç¬¬ä¸‰æ ¡å€</option>
                </select>
              </div>
              <div class="issue-form-row">
                <label for="issue-building">å»ºç¯‰</label>
                <select id="issue-building" required>
                  <option value="">è«‹é¸æ“‡å»ºç¯‰ï¼ˆé¸æ“‡æ ¡å€å¾Œè‡ªå‹•å¡«å……ï¼‰</option>
                </select>
                <small style="font-size: 11px; color: #888; margin-top: 4px; display: block;">ğŸ’¡ æç¤ºï¼šå…ˆé¸æ“‡æ ¡å€ï¼Œå»ºç¯‰é¸å–®æœƒè‡ªå‹•å¡«å……</small>
              </div>
              <div class="issue-form-row">
                <label for="issue-floor">æ¨“å±¤</label>
                <input type="text" id="issue-floor" placeholder="ä¾‹ï¼š3Fã€3ã€3æ¨“ã€ä¸‰æ¨“ï¼ˆè‡ªå‹•æ ¼å¼åŒ–ç‚º 3Fï¼‰" required />
                <small style="font-size: 11px; color: #888; margin-top: 4px; display: block;">ğŸ’¡ æç¤ºï¼šè¼¸å…¥æ•¸å­—æˆ–ä¸­æ–‡æ•¸å­—ï¼Œç³»çµ±æœƒè‡ªå‹•æ ¼å¼åŒ–</small>
              </div>
              <div class="issue-form-row" id="issue-gender-row" style="display: none;">
                <label for="issue-gender">é¡å‹ *</label>
                <select id="issue-gender">
                  <option value="">è«‹é¸æ“‡é¡å‹</option>
                  <option value="ç”·">â™‚ï¸ ç”·å»</option>
                  <option value="å¥³">â™€ï¸ å¥³å»</option>
                  <option value="æ€§åˆ¥å‹å–„">ğŸš» æ€§åˆ¥å‹å–„å»æ‰€</option>
                  <option value="ç„¡éšœç¤™">â™¿ ç„¡éšœç¤™å»æ‰€</option>
                </select>
              </div>
              <div class="issue-form-row">
                <label for="issue-status">è¨­æ–½ç‹€æ…‹ *</label>
                <select id="issue-status" required>
                  <option value="">è«‹é¸æ“‡ç‹€æ…‹</option>
                  <option value="æ­£å¸¸">âœ… æ­£å¸¸</option>
                  <option value="éƒ¨åˆ†æå£">âš ï¸ éƒ¨åˆ†æå£</option>
                  <option value="å¾…æ¸…æ½”">ğŸ§¹ å¾…æ¸…æ½”</option>
                  <option value="ç„¡æ³•ä½¿ç”¨">ğŸš« ç„¡æ³•ä½¿ç”¨</option>
                </select>
              </div>
              <div class="issue-form-row">
                <label for="issue-remark">è£œå……èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
                <textarea id="issue-remark" rows="3" placeholder="ä¾‹ï¼šç²½ä¸‰é¤¨å››æ¨“æœ€é çª—çš„å°ä¾¿æ–—è£¡é¢æœ‰å¤§ä¾¿"></textarea>
              </div>
              <div class="issue-form-row">
                <label for="issue-photo">ä¸Šå‚³ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
                <input type="file" id="issue-photo" accept="image/*" />
                <div id="issue-photo-preview" style="margin-top: 8px; display: none;">
                  <img id="issue-photo-img" style="max-width: 200px; max-height: 200px; border-radius: 4px;" />
                  <button type="button" id="issue-photo-remove" style="margin-left: 8px;">ç§»é™¤</button>
                </div>
              </div>
              <input type="hidden" id="issue-facility-id" />
              <input type="hidden" id="issue-photo-base64" />
              <div class="issue-form-summary" id="issue-facility-summary">
                å°‡è‡ªå‹•é¸æ“‡è·é›¢æ‚¨æœ€è¿‘çš„è¨­å‚™ä½œç‚ºé è¨­å›å ±ç›®æ¨™ã€‚
              </div>
              <div class="issue-form-actions">
                <button type="button" id="issue-cancel-btn" class="issue-btn secondary">å–æ¶ˆ</button>
                <button type="submit" class="issue-btn primary">é€å‡ºå›å ±</button>
              </div>
            </form>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="quick-actions">
            <button type="button" class="quick-btn" data-query="æœ€è¿‘çš„å»æ‰€åœ¨å“ª" aria-label="æŸ¥è©¢æœ€è¿‘çš„å»æ‰€">ğŸš» æœ€è¿‘å»æ‰€</button>
            <button type="button" class="quick-btn" data-query="æœ€è¿‘çš„é£²æ°´æ©Ÿåœ¨å“ª" aria-label="æŸ¥è©¢æœ€è¿‘çš„é£²æ°´æ©Ÿ">ğŸš° æœ€è¿‘é£²æ°´æ©Ÿ</button>
            <button type="button" class="quick-btn" data-query="æœ€è¿‘çš„åƒåœ¾æ¡¶åœ¨å“ª" aria-label="æŸ¥è©¢æœ€è¿‘çš„åƒåœ¾æ¡¶">ğŸ—‘ï¸ æœ€è¿‘åƒåœ¾æ¡¶</button>
            <button type="button" class="quick-btn" data-query="æ™ºèƒ½è·¯ç·šè¦åŠƒåˆ°å»æ‰€" id="smart-route-btn" aria-label="æ™ºèƒ½è·¯ç·šè¦åŠƒ">ğŸ§­ æ™ºèƒ½è·¯ç·š</button>
            <button type="button" class="quick-btn" data-query="å¿«é€Ÿå›å ±å•é¡Œ" id="quick-report-btn" aria-label="å¿«é€Ÿå›å ±å•é¡Œ">âš¡ å¿«é€Ÿå›å ±</button>
            <button type="button" class="quick-btn" data-query="æŸ¥çœ‹çµ±è¨ˆè³‡è¨Š" id="statistics-btn" aria-label="æŸ¥çœ‹çµ±è¨ˆè³‡è¨Š">ğŸ“Š çµ±è¨ˆ</button>
          </div>
          <div class="input-wrapper">
            <label for="chat-input" class="sr-only">è¼¸å…¥ä½ çš„å•é¡Œ</label>
            <input 
              type="text" 
              id="chat-input" 
              class="chat-input" 
              placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..."
              autocomplete="off"
              aria-label="è¼¸å…¥ä½ çš„å•é¡Œ"
              aria-describedby="chat-input-description"
              role="textbox"
            />
            <span id="chat-input-description" class="sr-only">åœ¨æ­¤è¼¸å…¥å•é¡Œï¼ŒæŒ‰ Enter æˆ–é»æ“Šç™¼é€æŒ‰éˆ•ç™¼é€</span>
            <button type="button" id="send-btn" class="send-btn" aria-label="ç™¼é€æ¶ˆæ¯" aria-describedby="send-btn-description">
              <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="sr-only">ç™¼é€</span>
            </button>
            <span id="send-btn-description" class="sr-only">ç™¼é€æ‚¨çš„å•é¡Œçµ¦ AI åŠ©æ‰‹</span>
          </div>
        </div>
      </div>

      <!-- å³å´ï¼šåœ°åœ–å€ -->
      <div class="map-panel">
        <div class="map-header">
          <h3>ğŸ“ åœ°åœ–å°èˆª</h3>
          <div class="map-controls">
            <button type="button" id="location-btn" class="location-btn" title="å®šä½åˆ°æˆ‘çš„ä½ç½®">ğŸ“ æˆ‘çš„ä½ç½®</button>
            <select id="map-campus-select" class="map-select">
              <option value="campus1">ç¬¬ä¸€æ ¡å€</option>
              <option value="campus2">ç¬¬äºŒæ ¡å€</option>
              <option value="campus3">ç¬¬ä¸‰æ ¡å€</option>
            </select>
          </div>
        </div>
        <div class="map-wrapper">
          <div class="loading" id="map-loading">
            <div class="spinner"></div>
            <div>è¼‰å…¥åœ°åœ–ä¸­...</div>
          </div>
          <div id="ai-map"></div>
        </div>
        <div class="map-info" id="map-info">
          <p>ç­‰å¾… AI æŒ‡ä»¤...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- AI å°è©±ç³»çµ± -->
  <script src="ai-chat.js"></script>
  <!-- å‰ç«¯è«‹æ±‚ç›£æ§å·¥å…·ï¼ˆF12 æ§åˆ¶å°ä¸­ä½¿ç”¨ï¼‰ -->
  <!-- <script src="æŸ¥çœ‹å‰ç«¯è«‹æ±‚.js"></script> -->
  <!-- ç§»å‹•è¨­å‚™æª¢æ¸¬å·²åœ¨ head ä¸­åŸ·è¡Œï¼Œæ­¤è™•ä¸å†é‡è¤‡æª¢æ¸¬ -->
</body>
</html>

