# 環境變數對照表

本文檔說明前端（Vercel）和後端（Zeabur）所需的環境變數配置，確保兩個平台使用相同的環境變數和連接邏輯。

## 部署架構

```
前端 (Vercel)
├── 靜態檔案 (HTML/CSS/JS)
├── API Routes (api/rasa/*, api/gemini/*)
└── 環境變數: RASA_SERVER_URL, GEMINI_API_KEY, GEMINI_MODEL

後端 (Zeabur)
├── Rasa 服務 (Dockerfile)
├── Action Server (Dockerfile.action-server)
└── 環境變數: ACTION_SERVER_URL, SUPABASE_MODEL_URL, PORT, GEMINI_API_KEY
```

## Vercel 環境變數配置

### 必需環境變數

| 變數名稱 | 描述 | 範例值 | 用途 |
|---------|------|--------|------|
| `RASA_SERVER_URL` | Rasa 服務器的完整 URL（部署在 Zeabur） | `https://rasa-service.zeabur.app` | Vercel API Routes (`api/rasa/status.js` 和 `api/rasa/webhook.js`) 使用此 URL 代理請求到 Zeabur Rasa 服務 |
| `GEMINI_API_KEY` | Google Gemini API 金鑰 | `your_gemini_api_key` | `api/gemini/chat.js` 使用此金鑰呼叫 Gemini API |

### 可選環境變數

| 變數名稱 | 描述 | 預設值 | 用途 |
|---------|------|--------|------|
| `GEMINI_MODEL` | Gemini 模型名稱 | `gemini-2.0-flash-exp` | `api/gemini/chat.js` 使用此模型名稱 |

### Vercel 配置步驟

1. **登入 Vercel Dashboard**
   - 訪問 https://vercel.com/dashboard
   - 選擇專案 `school-app`

2. **進入環境變數設置**
   - 點擊專案設置（Settings）
   - 選擇 **Environment Variables** 選項卡

3. **添加環境變數**
   - 點擊 **Add New** 按鈕
   - 輸入以下信息：
     - **Key**: `RASA_SERVER_URL`
     - **Value**: `https://rasa-service.zeabur.app`（替換為您的實際 Zeabur Rasa 服務 URL）
     - **Environment**: 選擇所有環境（Production、Preview、Development）
   - 重複上述步驟添加 `GEMINI_API_KEY`
   - 點擊 **Save**

4. **重新部署**
   - 環境變數設置後，Vercel 會自動觸發重新部署
   - 或者手動點擊 **Redeploy** 按鈕

## Zeabur Rasa 服務環境變數配置

### 自動設置的環境變數

| 變數名稱 | 描述 | 自動設置值 |
|---------|------|-----------|
| `PORT` | 服務端口 | `8080`（Zeabur 自動設置） |

### 必需環境變數

| 變數名稱 | 描述 | 範例值 | 用途 |
|---------|------|--------|------|
| `SUPABASE_MODEL_URL` | Supabase Storage 中的模型檔案 URL | `https://your-supabase-storage-url/model.tar.gz` | `rasa/start.sh` 使用此 URL 下載 Rasa 訓練模型 |

### 可選環境變數

| 變數名稱 | 描述 | 範例值 | 用途 |
|---------|------|--------|------|
| `MODEL_DOWNLOAD_URL` | 備用模型下載 URL | `https://example.com/model.tar.gz` | 如果 `SUPABASE_MODEL_URL` 下載失敗，嘗試此 URL |
| `VOLUME_MODEL_PATH` | Volume 中的模型檔案路徑 | `/volume/models/model.tar.gz` | 如果使用 Zeabur Volume 存儲模型，使用此路徑 |

### Zeabur Rasa 服務配置步驟

1. **登入 Zeabur Dashboard**
   - 訪問 https://zeabur.com/dashboard
   - 選擇您的專案

2. **進入 Rasa 服務設置**
   - 選擇 Rasa 服務
   - 點擊 **Environment Variables** 選項卡

3. **添加環境變數**
   - 點擊 **Add Variable** 按鈕
   - 輸入以下信息：
     - **Key**: `SUPABASE_MODEL_URL`
     - **Value**: 您的 Supabase Storage URL（例如：`https://your-project.supabase.co/storage/v1/object/public/models/rasa-model.tar.gz`）
   - 點擊 **Save**

4. **重新部署**
   - 環境變數設置後，Zeabur 會自動觸發重新部署

## Zeabur Action Server 環境變數配置

### 自動設置的環境變數

| 變數名稱 | 描述 | 自動設置值 |
|---------|------|-----------|
| `PORT` | 服務端口 | `5055`（Zeabur 自動設置） |
| `ACTION_SERVER_URL` | Action Server 的完整 URL | `https://rasa-action-server-xxx.zeabur.app`（Zeabur 自動生成） |

### 必需環境變數

| 變數名稱 | 描述 | 範例值 | 用途 |
|---------|------|--------|------|
| `GEMINI_API_KEY` | Google Gemini API 金鑰 | `your_gemini_api_key` | Action Server 中的 Actions 使用此金鑰呼叫 Gemini API（與 Vercel 相同） |

### Zeabur Action Server 配置步驟

1. **登入 Zeabur Dashboard**
   - 訪問 https://zeabur.com/dashboard
   - 選擇您的專案

2. **進入 Action Server 服務設置**
   - 選擇 Action Server 服務
   - 點擊 **Environment Variables** 選項卡

3. **添加環境變數**
   - 點擊 **Add Variable** 按鈕
   - 輸入以下信息：
     - **Key**: `GEMINI_API_KEY`
     - **Value**: 您的 Gemini API 金鑰（與 Vercel 相同）
   - 點擊 **Save**

4. **配置 Rasa 服務連接 Action Server**
   - 在 Rasa 服務的環境變數中，確保 `ACTION_SERVER_URL` 已設置（通常由 Zeabur 自動設置）
   - 或者手動設置為 Action Server 的 URL

5. **重新部署**
   - 環境變數設置後，Zeabur 會自動觸發重新部署

## 連接邏輯確保

### 前端 → 後端連接

1. **Vercel API Routes** 使用 `RASA_SERVER_URL` 環境變數
   - `api/rasa/webhook.js` 轉發請求到 `${RASA_SERVER_URL}/webhooks/rest/webhook`
   - `api/rasa/status.js` 檢查 `${RASA_SERVER_URL}/status`

2. **前端 JavaScript** 直接連接到 Zeabur Rasa 服務
   - `ai-chat.js` 中的邏輯會自動檢測 Vercel 環境
   - 在 Vercel 環境中，會優先使用 Zeabur Rasa 服務器 URL

3. **CORS 配置** 確保跨域請求正常
   - Vercel API Routes 設置了 `Access-Control-Allow-Origin: *`
   - Zeabur Rasa 服務在啟動時設置了 `--cors "*"`

### 後端內部連接

1. **Rasa → Action Server**: 通過 `rasa/endpoints.yml` 中的 `action_endpoint.url`
   - 本地開發：`http://localhost:5055/webhook`
   - 雲端部署：使用環境變數 `${ACTION_SERVER_URL}/webhook`
   - 注意：`endpoints.yml` 目前配置為本地，需要在 Zeabur 部署時動態設置

2. **環境變數注入**: 使用 `${ACTION_SERVER_URL}` 在部署時動態設置
   - Zeabur 會自動設置 `ACTION_SERVER_URL` 環境變數
   - 可以在 `rasa/start.sh` 中動態更新 `endpoints.yml` 或使用環境變數

## 驗證配置

### 驗證 Vercel 配置

1. **檢查 API 端點**
   - 訪問 `https://your-app.vercel.app/api/rasa/status`
   - 如果配置正確，應該能連接到 Zeabur Rasa 服務
   - 如果未配置，會返回 `"status": "no_server"` 的 JSON 響應

2. **檢查部署日誌**
   - 在 Vercel Dashboard 中查看最新部署的日誌
   - 確認沒有環境變數相關的錯誤

### 驗證 Zeabur 配置

1. **檢查 Rasa 服務狀態**
   - 訪問 `https://rasa-service.zeabur.app/status`
   - 應該返回 Rasa 服務狀態信息

2. **檢查 Action Server 狀態**
   - 訪問 `https://rasa-action-server-xxx.zeabur.app/health`
   - 應該返回 `{"status": "ok"}`

3. **檢查部署日誌**
   - 在 Zeabur Dashboard 中查看最新部署的日誌
   - 確認模型下載成功（如果使用 `SUPABASE_MODEL_URL`）
   - 確認服務啟動成功

## 注意事項

1. **模型檔案**: 不推送到 GitHub，使用外部存儲（Supabase Storage）
2. **環境變數**: 需要在兩個平台分別設置
3. **CORS**: 確保 Zeabur 服務允許 Vercel 域名
4. **API 金鑰**: 不要在程式碼中硬編碼，使用環境變數
5. **檔案大小限制**: GitHub 單檔案限制 100MB，超過的檔案需要外部存儲
6. **相同 API 金鑰**: `GEMINI_API_KEY` 在 Vercel 和 Zeabur Action Server 中應該使用相同的值

## 相關文檔

- `Vercel環境變數配置指引.md` - Vercel 環境變數設置詳細說明
- `Zeabur配置說明.md` - Zeabur 配置詳細說明
- `大型檔案上傳指引.md` - 大型檔案手動上傳指引

---

**最後更新**: 2025-12-25  
**配置狀態**: ✅ 完成
